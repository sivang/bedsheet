# {{ config.name }} - Terraform Configuration for AWS Bedrock
# Generated by: bedsheet generate --target aws-terraform
#
# This creates:
# - IAM role for Bedrock agents with multi-agent collaboration permissions
{% if agent.is_supervisor and agent.collaborators %}
# - Collaborator agents: {{ agent.collaborators | map(attribute='name') | join(', ') }}
# - Supervisor agent: {{ agent.name }}
{% else %}
# - Single Bedrock agent: {{ agent.name }}
{% endif %}
# - Agent aliases for invocation
# - Lambda function for action groups (if tools are defined)

terraform {
  required_version = ">= 1.0.0"

  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = ">= 5.0.0"
    }
  }
}

provider "aws" {
  region = var.region
}

# ============================================
# Workspace and Environment Configuration
# ============================================

locals {
  workspace = terraform.workspace == "default" ? "dev" : terraform.workspace
  name_prefix = "${var.project_name}-${local.workspace}"
}

# ============================================
# IAM Role for Bedrock Agents
# ============================================

resource "aws_iam_role" "agent_role" {
  name = "bedsheet-${local.name_prefix}-agent-role"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Principal = {
          Service = "bedrock.amazonaws.com"
        }
        Action = "sts:AssumeRole"
      }
    ]
  })

  tags = {
    ManagedBy       = "Bedsheet"
    BedsheetVersion = "0.4.7"
    Project         = var.project_name
    Environment     = local.workspace
  }
}

# Attach AmazonBedrockFullAccess managed policy
resource "aws_iam_role_policy_attachment" "bedrock_full_access" {
  role       = aws_iam_role.agent_role.name
  policy_arn = "arn:aws:iam::aws:policy/AmazonBedrockFullAccess"
}

# Multi-agent collaboration and model invocation permissions
resource "aws_iam_role_policy" "agent_permissions" {
  name = "bedsheet-${local.name_prefix}-agent-permissions"
  role = aws_iam_role.agent_role.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = [
          "bedrock-agent-runtime:InvokeAgent",
          "bedrock:InvokeModel",
          "bedrock:InvokeModelWithResponseStream"
        ]
        Resource = "*"
      }
    ]
  })
}

{% if agent.tools or (agent.is_supervisor and agent.collaborators and aws.enable_delegate_for_supervisors) %}
# ============================================
# Lambda Function for Action Groups
# ============================================

resource "aws_iam_role" "lambda_role" {
  name = "bedsheet-${local.name_prefix}-lambda-role"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Principal = {
          Service = "lambda.amazonaws.com"
        }
        Action = "sts:AssumeRole"
      }
    ]
  })

  tags = {
    ManagedBy       = "Bedsheet"
    BedsheetVersion = "0.4.7"
    Project         = var.project_name
    Environment     = local.workspace
  }
}

resource "aws_iam_role_policy_attachment" "lambda_basic" {
  role       = aws_iam_role.lambda_role.name
  policy_arn = "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
}

resource "aws_iam_role_policy" "lambda_bedrock" {
  name = "bedsheet-${local.name_prefix}-lambda-bedrock"
  role = aws_iam_role.lambda_role.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect   = "Allow"
        Action   = ["bedrock:InvokeModel"]
        Resource = "*"
      }{% if agent.is_supervisor and agent.collaborators and aws.enable_delegate_for_supervisors %},
      {
        Effect   = "Allow"
        Action   = ["bedrock-agent-runtime:InvokeAgent"]
        Resource = "*"
      }{% endif %}
    ]
  })
}

# Package Lambda code
data "archive_file" "lambda_zip" {
  type        = "zip"
  source_dir  = "${path.module}/lambda"
  output_path = "${path.module}/lambda.zip"
}

resource "aws_lambda_function" "action_lambda" {
  filename         = data.archive_file.lambda_zip.output_path
  function_name    = "bedsheet-${local.name_prefix}-actions"
  role            = aws_iam_role.lambda_role.arn
  handler         = "handler.lambda_handler"
  source_code_hash = data.archive_file.lambda_zip.output_base64sha256
  runtime         = "python3.11"
  memory_size     = {{ aws.lambda_memory or 512 }}
  timeout         = 30

{% if agent.is_supervisor and agent.collaborators and aws.enable_delegate_for_supervisors %}
  environment {
    variables = {
{% for collaborator in agent.collaborators %}
      COLLABORATOR_{{ collaborator.name | upper }}_AGENT_ID  = aws_bedrockagent_agent.{{ collaborator.name | lower }}.agent_id
      COLLABORATOR_{{ collaborator.name | upper }}_ALIAS_ID  = aws_bedrockagent_agent_alias.{{ collaborator.name | lower }}.agent_alias_id
{% endfor %}
    }
  }
{% endif %}

  tags = {
    ManagedBy       = "Bedsheet"
    BedsheetVersion = "0.4.7"
    Project         = var.project_name
    Environment     = local.workspace
  }
}

# Allow Bedrock to invoke Lambda
resource "aws_lambda_permission" "bedrock_invoke" {
  statement_id  = "AllowBedrockInvoke"
  action        = "lambda:InvokeFunction"
  function_name = aws_lambda_function.action_lambda.function_name
  principal     = "bedrock.amazonaws.com"
}
{% endif %}

{% if agent.is_supervisor and agent.collaborators %}
# ============================================
# Multi-Agent Collaboration Setup
# ============================================

{% for collaborator in agent.collaborators %}
# Collaborator Agent: {{ collaborator.name }}
resource "aws_bedrockagent_agent" "{{ collaborator.name | lower }}" {
  agent_name              = "${local.name_prefix}_{{ collaborator.name | lower }}"
  agent_resource_role_arn = aws_iam_role.agent_role.arn
  foundation_model        = var.bedrock_model
  instruction             = <<-EOT
{{ collaborator.instruction }}
  EOT

  prepare_agent = true

  tags = {
    ManagedBy       = "Bedsheet"
    BedsheetVersion = "0.4.7"
    Project         = var.project_name
    Environment     = local.workspace
    AgentType       = "Collaborator"
  }
}

resource "aws_bedrockagent_agent_alias" "{{ collaborator.name | lower }}" {
  agent_alias_name = "live"
  agent_id         = aws_bedrockagent_agent.{{ collaborator.name | lower }}.agent_id
  description      = "Live alias for {{ collaborator.name }}"
}

{% endfor %}

# Supervisor Agent: {{ agent.name }}
resource "aws_bedrockagent_agent" "supervisor" {
  agent_name              = local.name_prefix
  agent_resource_role_arn = aws_iam_role.agent_role.arn
  foundation_model        = var.bedrock_model
  instruction             = <<-EOT
{{ agent.instruction }}
  EOT

{% if not aws.enable_delegate_for_supervisors %}
  # Enable native multi-agent collaboration
  agent_collaboration = "SUPERVISOR"

  # Don't prepare supervisor until collaborators are attached
  # Collaborators will trigger preparation when they're added
  prepare_agent = false
{% else %}
  # Using delegate action instead of native collaboration
  # Prepare agent immediately since there are no collaborator connections
  prepare_agent = false  # Will be prepared by action group
{% endif %}

  tags = {
    ManagedBy       = "Bedsheet"
    BedsheetVersion = "0.4.7"
    Project         = var.project_name
    Environment     = local.workspace
    AgentType       = "Supervisor"
  }
}

{% if agent.tools %}
# Action Group for supervisor (separate resource)
resource "aws_bedrockagent_agent_action_group" "supervisor_actions" {
  action_group_name = "${local.name_prefix}_actions"
  agent_id          = aws_bedrockagent_agent.supervisor.agent_id
  agent_version     = "DRAFT"

  action_group_executor {
    lambda = aws_lambda_function.action_lambda.arn
  }

  api_schema {
    payload = file("${path.module}/schemas/openapi.yaml")
  }

  prepare_agent = true
  depends_on    = [aws_lambda_permission.bedrock_invoke]
}
{% endif %}

# Native Bedrock collaborator connections (only when delegate is disabled)
{% if not aws.enable_delegate_for_supervisors %}
{% for collaborator in agent.collaborators %}
resource "aws_bedrockagent_agent_collaborator" "{{ collaborator.name | lower }}" {
  agent_id                  = aws_bedrockagent_agent.supervisor.agent_id
  agent_version             = "DRAFT"
  collaborator_name         = "{{ collaborator.name }}"
  collaboration_instruction = <<-EOT
{{ collaborator.instruction[:500] }}
  EOT

  agent_descriptor {
    alias_arn = aws_bedrockagent_agent_alias.{{ collaborator.name | lower }}.agent_alias_arn
  }

  relay_conversation_history = "TO_COLLABORATOR"
  prepare_agent              = true
}

{% endfor %}
{% endif %}

resource "aws_bedrockagent_agent_alias" "supervisor" {
  agent_alias_name = "live"
  agent_id         = aws_bedrockagent_agent.supervisor.agent_id
  description      = "Live alias for {{ agent.name }}"
}

{% else %}
# ============================================
# Single Agent Setup
# ============================================

resource "aws_bedrockagent_agent" "main" {
  agent_name              = local.name_prefix
  agent_resource_role_arn = aws_iam_role.agent_role.arn
  foundation_model        = var.bedrock_model
  instruction             = <<-EOT
{{ agent.instruction }}
  EOT

  prepare_agent = true

  tags = {
    ManagedBy       = "Bedsheet"
    BedsheetVersion = "0.4.7"
    Project         = var.project_name
    Environment     = local.workspace
    AgentType       = "SingleAgent"
  }
}

{% if agent.tools %}
# Action Group for main agent (separate resource)
resource "aws_bedrockagent_agent_action_group" "main_actions" {
  action_group_name = "${local.name_prefix}_actions"
  agent_id          = aws_bedrockagent_agent.main.agent_id
  agent_version     = "DRAFT"

  action_group_executor {
    lambda = aws_lambda_function.action_lambda.arn
  }

  api_schema {
    payload = file("${path.module}/schemas/openapi.yaml")
  }

  prepare_agent = true
  depends_on    = [aws_lambda_permission.bedrock_invoke]
}
{% endif %}

resource "aws_bedrockagent_agent_alias" "main" {
  agent_alias_name = "live"
  agent_id         = aws_bedrockagent_agent.main.agent_id
  description      = "Live alias for {{ agent.name }}"
}
{% endif %}
