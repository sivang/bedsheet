"""
{{ config.name }} - Bedrock Agent Stack
Generated by: bedsheet deploy --target aws
"""
from constructs import Construct
from aws_cdk import (
    Stack,
    Duration,
    RemovalPolicy,
    CfnOutput,
    CustomResource,
    aws_bedrock as bedrock,
    aws_lambda as lambda_,
    aws_iam as iam,
    aws_logs as logs,
    custom_resources as cr,
)


class AgentStack(Stack):
    """CDK Stack for {{ agent.name }} Bedrock Agent."""

    def __init__(self, scope: Construct, construct_id: str, **kwargs) -> None:
        super().__init__(scope, construct_id, **kwargs)

        # IAM role for Bedrock Agents
        agent_role = iam.Role(
            self, "AgentRole",
            assumed_by=iam.ServicePrincipal("bedrock.amazonaws.com"),
            managed_policies=[
                iam.ManagedPolicy.from_aws_managed_policy_name("AmazonBedrockFullAccess"),
            ],
        )

        # Multi-agent and model invocation permissions
        agent_role.add_to_policy(
            iam.PolicyStatement(
                actions=[
                    "bedrock-agent-runtime:InvokeAgent",
                    "bedrock:InvokeModel",
                    "bedrock:InvokeModelWithResponseStream"
                ],
                resources=["*"],
            )
        )

        {% if agent.tools %}
        # Lambda function for supervisor action groups
        action_lambda = lambda_.Function(
            self, "ActionLambda",
            runtime=lambda_.Runtime.PYTHON_3_11,
            handler="handler.lambda_handler",
            code=lambda_.Code.from_asset("lambda"),
            memory_size={{ aws.lambda_memory or 512 }},
            timeout=Duration.seconds(30),
            log_retention=logs.RetentionDays.ONE_WEEK,
        )

        # Grant Bedrock permission to invoke Lambda
        action_lambda.grant_invoke(iam.ServicePrincipal("bedrock.amazonaws.com"))

        # Lambda execution role policy
        action_lambda.add_to_role_policy(
            iam.PolicyStatement(
                actions=["bedrock:InvokeModel"],
                resources=["*"],
            )
        )
        {% endif %}

        {% if agent.is_supervisor and agent.collaborators %}
        # ============================================
        # Multi-Agent Collaboration Setup
        # ============================================
        # Create collaborator agents first, then link to supervisor

        collaborator_aliases = {}

        {% for collaborator in agent.collaborators %}
        # Collaborator: {{ collaborator.name }}
        {{ collaborator.name | lower }}_agent = bedrock.CfnAgent(
            self, "{{ collaborator.name }}Agent",
            agent_name="{{ project_name }}_{{ collaborator.name | lower }}",
            agent_resource_role_arn=agent_role.role_arn,
            instruction="""{{ collaborator.instruction | replace('"', '\\"') | replace('\n', '\\n') }}""",
            foundation_model="{{ aws.bedrock_model or 'anthropic.claude-3-sonnet-20240229-v1:0' }}",
            auto_prepare=True,
        )

        {{ collaborator.name | lower }}_alias = bedrock.CfnAgentAlias(
            self, "{{ collaborator.name }}Alias",
            agent_alias_name="live",
            agent_id={{ collaborator.name | lower }}_agent.attr_agent_id,
        )
        collaborator_aliases["{{ collaborator.name }}"] = {{ collaborator.name | lower }}_alias

        {% endfor %}

        # Supervisor Agent with Multi-Agent Collaboration
        supervisor_agent = bedrock.CfnAgent(
            self, "SupervisorAgent",
            agent_name="{{ project_name }}",
            agent_resource_role_arn=agent_role.role_arn,
            instruction="""{{ agent.instruction | replace('"', '\\"') | replace('\n', '\\n') }}""",
            foundation_model="{{ aws.bedrock_model or 'anthropic.claude-3-sonnet-20240229-v1:0' }}",
            {% if agent.tools %}
            action_groups=[
                bedrock.CfnAgent.AgentActionGroupProperty(
                    action_group_name="{{ project_name }}_actions",
                    action_group_executor=bedrock.CfnAgent.ActionGroupExecutorProperty(
                        lambda_=action_lambda.function_arn,
                    ),
                    api_schema=bedrock.CfnAgent.APISchemaProperty(
                        payload=open("schemas/openapi.yaml").read(),
                    ),
                ),
            ],
            {% endif %}
            # Enable multi-agent collaboration as supervisor
            agent_collaboration="SUPERVISOR",
            agent_collaborators=[
                {% for collaborator in agent.collaborators %}
                bedrock.CfnAgent.AgentCollaboratorProperty(
                    collaborator_name="{{ collaborator.name }}",
                    agent_descriptor=bedrock.CfnAgent.AgentDescriptorProperty(
                        alias_arn=collaborator_aliases["{{ collaborator.name }}"].attr_agent_alias_arn,
                    ),
                    collaboration_instruction="""{{ collaborator.instruction[:500] | replace('"', '\\"') | replace('\n', '\\n') }}""",
                    relay_conversation_history="TO_COLLABORATOR",
                ),
                {% endfor %}
            ],
            auto_prepare=True,
        )

        # Supervisor Agent Alias for invoking
        supervisor_alias = bedrock.CfnAgentAlias(
            self, "SupervisorAlias",
            agent_alias_name="live",
            agent_id=supervisor_agent.attr_agent_id,
        )

        # Custom Resource to prepare all agents after deployment
        prepare_agents_provider = cr.Provider(
            self, "PrepareAgentsProvider",
            on_event_handler=lambda_.Function(
                self, "PrepareAgentsLambda",
                runtime=lambda_.Runtime.PYTHON_3_11,
                handler="index.handler",
                code=lambda_.Code.from_inline("""
import boto3
import json

bedrock = boto3.client('bedrock-agent')

def handler(event, context):
    request_type = event['RequestType']
    if request_type in ['Create', 'Update']:
        agent_ids = event['ResourceProperties']['AgentIds'].split(',')
        for agent_id in agent_ids:
            bedrock.prepare_agent(agentId=agent_id)
    return {'PhysicalResourceId': 'PrepareAgents'}
                """),
                timeout=Duration.seconds(60),
                initial_policy=[
                    iam.PolicyStatement(
                        actions=["bedrock:PrepareAgent", "bedrock:GetAgent"],
                        resources=["*"],
                    )
                ],
            ),
        )

        CustomResource(
            self, "PrepareAgents",
            service_token=prepare_agents_provider.service_token,
            properties={
                "AgentIds": ",".join([
                    supervisor_agent.attr_agent_id,
                    {% for collaborator in agent.collaborators %}
                    {{ collaborator.name | lower }}_agent.attr_agent_id,
                    {% endfor %}
                ]),
            },
        )

        # Outputs
        CfnOutput(self, "SupervisorAgentId", value=supervisor_agent.attr_agent_id)
        CfnOutput(self, "SupervisorAliasArn", value=supervisor_alias.attr_agent_alias_arn)
        {% for collaborator in agent.collaborators %}
        CfnOutput(self, "{{ collaborator.name }}AgentId", value={{ collaborator.name | lower }}_agent.attr_agent_id)
        {% endfor %}

        {% else %}
        # ============================================
        # Single Agent Setup
        # ============================================

        # Bedrock Agent
        agent = bedrock.CfnAgent(
            self, "BedrockAgent",
            agent_name="{{ project_name }}",
            agent_resource_role_arn=agent_role.role_arn,
            instruction="""{{ agent.instruction | replace('"', '\\"') | replace('\n', '\\n') }}""",
            foundation_model="{{ aws.bedrock_model or 'anthropic.claude-3-sonnet-20240229-v1:0' }}",
            {% if agent.tools %}
            action_groups=[
                bedrock.CfnAgent.AgentActionGroupProperty(
                    action_group_name="{{ project_name }}_actions",
                    action_group_executor=bedrock.CfnAgent.ActionGroupExecutorProperty(
                        lambda_=action_lambda.function_arn,
                    ),
                    api_schema=bedrock.CfnAgent.APISchemaProperty(
                        payload=open("schemas/openapi.yaml").read(),
                    ),
                ),
            ],
            {% endif %}
            auto_prepare=True,
        )

        # Agent Alias for invoking
        alias = bedrock.CfnAgentAlias(
            self, "AgentAlias",
            agent_alias_name="live",
            agent_id=agent.attr_agent_id,
        )

        # Custom Resource to prepare agent after deployment
        prepare_agent_provider = cr.Provider(
            self, "PrepareAgentProvider",
            on_event_handler=lambda_.Function(
                self, "PrepareAgentLambda",
                runtime=lambda_.Runtime.PYTHON_3_11,
                handler="index.handler",
                code=lambda_.Code.from_inline("""
import boto3

bedrock = boto3.client('bedrock-agent')

def handler(event, context):
    request_type = event['RequestType']
    if request_type in ['Create', 'Update']:
        agent_id = event['ResourceProperties']['AgentId']
        bedrock.prepare_agent(agentId=agent_id)
    return {'PhysicalResourceId': 'PrepareAgent'}
                """),
                timeout=Duration.seconds(60),
                initial_policy=[
                    iam.PolicyStatement(
                        actions=["bedrock:PrepareAgent", "bedrock:GetAgent"],
                        resources=["*"],
                    )
                ],
            ),
        )

        CustomResource(
            self, "PrepareAgent",
            service_token=prepare_agent_provider.service_token,
            properties={
                "AgentId": agent.attr_agent_id,
            },
        )

        # Outputs
        CfnOutput(self, "AgentId", value=agent.attr_agent_id)
        CfnOutput(self, "AliasArn", value=alias.attr_agent_alias_arn)
        {% endif %}
