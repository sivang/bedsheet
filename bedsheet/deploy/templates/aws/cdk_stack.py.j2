"""
{{ config.name }} - Bedrock Agent Stack
Generated by: bedsheet deploy --target aws
"""
from constructs import Construct
from aws_cdk import (
    Stack,
    Duration,
    RemovalPolicy,
    aws_bedrock as bedrock,
    aws_lambda as lambda_,
    aws_iam as iam,
    aws_logs as logs,
)


class AgentStack(Stack):
    """CDK Stack for {{ agent.name }} Bedrock Agent."""

    def __init__(self, scope: Construct, construct_id: str, **kwargs) -> None:
        super().__init__(scope, construct_id, **kwargs)

        # IAM role for Bedrock Agent
        agent_role = iam.Role(
            self, "AgentRole",
            assumed_by=iam.ServicePrincipal("bedrock.amazonaws.com"),
            managed_policies=[
                iam.ManagedPolicy.from_aws_managed_policy_name("AmazonBedrockFullAccess"),
            ],
        )

        {% if agent.tools %}
        # Lambda function for action groups
        action_lambda = lambda_.Function(
            self, "ActionLambda",
            runtime=lambda_.Runtime.PYTHON_3_11,
            handler="handler.lambda_handler",
            code=lambda_.Code.from_asset("lambda"),
            memory_size={{ aws.lambda_memory or 512 }},
            timeout=Duration.seconds(30),
            log_retention=logs.RetentionDays.ONE_WEEK,
        )

        # Grant Bedrock permission to invoke Lambda
        action_lambda.grant_invoke(iam.ServicePrincipal("bedrock.amazonaws.com"))

        # Lambda execution role policy
        action_lambda.add_to_role_policy(
            iam.PolicyStatement(
                actions=["bedrock:InvokeModel"],
                resources=["*"],
            )
        )
        {% endif %}

        # Bedrock Agent
        agent = bedrock.CfnAgent(
            self, "BedrockAgent",
            agent_name="{{ project_name }}",
            agent_resource_role_arn=agent_role.role_arn,
            instruction="""{{ agent.instruction | replace('"', '\\"') | replace('\n', '\\n') }}""",
            foundation_model="{{ aws.bedrock_model or 'anthropic.claude-3-sonnet-20240229-v1:0' }}",
            {% if agent.tools %}
            action_groups=[
                bedrock.CfnAgent.AgentActionGroupProperty(
                    action_group_name="{{ project_name }}_actions",
                    action_group_executor=bedrock.CfnAgent.ActionGroupExecutorProperty(
                        lambda_=action_lambda.function_arn,
                    ),
                    api_schema=bedrock.CfnAgent.APISchemaProperty(
                        payload=open("schemas/openapi.yaml").read(),
                    ),
                ),
            ],
            {% endif %}
            auto_prepare=True,
        )

        # Agent Alias for invoking
        alias = bedrock.CfnAgentAlias(
            self, "AgentAlias",
            agent_alias_name="live",
            agent_id=agent.attr_agent_id,
        )
