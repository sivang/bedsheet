# {{ config.name }} - Terraform Variables
# Generated by: bedsheet deploy --target gcp
#
# Configure these variables in terraform.tfvars or via environment variables.
# Required variables have no defaults - you must provide them.

# =============================================================================
# REQUIRED VARIABLES
# =============================================================================

variable "project_id" {
  description = "GCP Project ID where resources will be created"
  type        = string
  {% if gcp.project and gcp.project != 'your-project-id' %}
  default     = "{{ gcp.project }}"
  {% endif %}

  validation {
    condition     = can(regex("^[a-z][a-z0-9-]{4,28}[a-z0-9]$", var.project_id))
    error_message = "Project ID must be 6-30 characters, start with a letter, and contain only lowercase letters, numbers, and hyphens."
  }
}

# =============================================================================
# DEPLOYMENT CONFIGURATION
# =============================================================================

variable "region" {
  description = "GCP Region for Cloud Run deployment"
  type        = string
  default     = "{{ gcp.region or 'europe-west1' }}"
}

variable "environment" {
  description = "Deployment environment (dev, staging, prod)"
  type        = string
  default     = "dev"

  validation {
    condition     = contains(["dev", "staging", "prod"], var.environment)
    error_message = "Environment must be one of: dev, staging, prod."
  }
}

variable "image_tag" {
  description = "Container image tag to deploy"
  type        = string
  default     = "latest"
}

# =============================================================================
# CLOUD RUN CONFIGURATION
# =============================================================================

variable "cpu_limit" {
  description = "CPU limit for Cloud Run container (e.g., '1', '2', '4')"
  type        = string
  default     = "1"
}

variable "memory_limit" {
  description = "Memory limit for Cloud Run container (e.g., '512Mi', '1Gi', '2Gi')"
  type        = string
  default     = "{{ gcp.cloud_run_memory or '512Mi' }}"

  validation {
    condition     = can(regex("^[0-9]+(Mi|Gi)$", var.memory_limit))
    error_message = "Memory limit must be in format like '512Mi' or '1Gi'."
  }
}

variable "min_instances" {
  description = "Minimum number of Cloud Run instances (0 = scale to zero)"
  type        = number
  default     = 0

  validation {
    condition     = var.min_instances >= 0 && var.min_instances <= 100
    error_message = "Minimum instances must be between 0 and 100."
  }
}

variable "max_instances" {
  description = "Maximum number of Cloud Run instances"
  type        = number
  default     = 10

  validation {
    condition     = var.max_instances >= 1 && var.max_instances <= 1000
    error_message = "Maximum instances must be between 1 and 1000."
  }
}

variable "request_timeout_seconds" {
  description = "Maximum time in seconds for a request (LLM calls can be slow)"
  type        = number
  default     = 300  # 5 minutes

  validation {
    condition     = var.request_timeout_seconds >= 1 && var.request_timeout_seconds <= 3600
    error_message = "Request timeout must be between 1 and 3600 seconds."
  }
}

variable "log_level" {
  description = "Application log level"
  type        = string
  default     = "INFO"

  validation {
    condition     = contains(["DEBUG", "INFO", "WARNING", "ERROR"], var.log_level)
    error_message = "Log level must be one of: DEBUG, INFO, WARNING, ERROR."
  }
}

# =============================================================================
# SECURITY & ACCESS CONTROL
# =============================================================================

variable "allow_unauthenticated" {
  description = "Allow unauthenticated (public) access to the Cloud Run service. Set to false for private APIs."
  type        = bool
  default     = false
}

variable "authorized_invokers" {
  description = "List of IAM members authorized to invoke the service (e.g., 'user:email@example.com', 'serviceAccount:sa@project.iam.gserviceaccount.com')"
  type        = list(string)
  default     = []

  validation {
    condition = alltrue([
      for member in var.authorized_invokers :
      can(regex("^(user:|serviceAccount:|group:|domain:)", member))
    ])
    error_message = "Each authorized invoker must start with 'user:', 'serviceAccount:', 'group:', or 'domain:'."
  }
}
