# {{ config.name }} - Production-Grade Terraform Configuration for GCP
# Generated by: bedsheet deploy --target gcp
#
# This creates a secure, production-ready ADK agent deployment:
# - API enablement with proper dependency chain
# - Service account with least-privilege IAM
# - Artifact Registry for container images
# - Cloud Run service with security hardening
# - Monitoring and observability integration
#
# Security Features:
# - Least-privilege service account
# - Optional private (authenticated) endpoints
# - Resource labels for governance
# - Cloud Logging and Monitoring integration

# =============================================================================
# TERRAFORM CONFIGURATION
# =============================================================================

terraform {
  required_version = ">= 1.5.0"

  required_providers {
    google = {
      source  = "hashicorp/google"
      version = ">= 5.0.0, < 7.0.0"
    }
    time = {
      source  = "hashicorp/time"
      version = ">= 0.9.0"
    }
  }
}

provider "google" {
  project = var.project_id
  region  = var.region
}

# =============================================================================
# LOCAL VALUES
# =============================================================================

locals {
  # GCP resource names can't have underscores, use hyphens
  service_name = "{{ project_name | replace('_', '-') }}"

  # Common labels for all resources (governance, cost tracking)
  common_labels = {
    managed_by       = "bedsheet"
    bedsheet_version = "0-4"
    project          = "{{ project_name | replace('_', '-') }}"
    environment      = var.environment
  }
}

# =============================================================================
# API ENABLEMENT
# =============================================================================
# Enable required GCP APIs. Cloud Build's service account has permissions.

resource "google_project_service" "required_apis" {
  for_each = toset([
    "cloudresourcemanager.googleapis.com", # Resource Manager (for IAM)
    "run.googleapis.com",                  # Cloud Run
    "artifactregistry.googleapis.com",     # Container Registry
    "aiplatform.googleapis.com",           # Vertex AI
    "cloudbuild.googleapis.com",           # Cloud Build
    "logging.googleapis.com",              # Cloud Logging
    "monitoring.googleapis.com",           # Cloud Monitoring
    "iam.googleapis.com",                  # IAM
    "iamcredentials.googleapis.com",       # IAM credentials
  ])

  project            = var.project_id
  service            = each.value
  disable_on_destroy = false

  timeouts {
    create = "10m"
    update = "10m"
  }
}

# Wait for APIs to propagate
resource "time_sleep" "api_propagation" {
  depends_on      = [google_project_service.required_apis]
  create_duration = "30s"
}

# =============================================================================
# SERVICE ACCOUNT
# =============================================================================
# Creates the service account. IAM role bindings are handled by Cloud Build
# using gcloud commands (more reliable than Terraform in CI/CD context).

resource "google_service_account" "agent" {
  depends_on   = [time_sleep.api_propagation]
  account_id   = "${local.service_name}-sa"
  display_name = "{{ config.name }} Agent Service Account"
  description  = "Service account for {{ config.name }} ADK agent on Cloud Run"
  project      = var.project_id
}

# NOTE: IAM role bindings (aiplatform.user, logging.logWriter, etc.) are
# granted via gcloud commands in cloudbuild.yaml for better CI/CD reliability.

# =============================================================================
# ARTIFACT REGISTRY
# =============================================================================

resource "google_artifact_registry_repository" "agent_repo" {
  depends_on = [time_sleep.api_propagation]
  location      = var.region
  repository_id = "${local.service_name}-repo"
  description   = "Docker repository for {{ config.name }} ADK agent"
  format        = "DOCKER"
  project       = var.project_id

  labels = local.common_labels

  # Cleanup policy - delete untagged images after 7 days (cost optimization)
  cleanup_policies {
    id     = "delete-untagged"
    action = "DELETE"
    condition {
      tag_state = "UNTAGGED"
      older_than = "604800s"  # 7 days
    }
  }
}

# =============================================================================
# CLOUD RUN SERVICE
# =============================================================================
# NOTE: Cloud Run service is created by `gcloud run deploy` in cloudbuild.yaml.
# This approach is more reliable in CI/CD (follows ADK Starter Pack pattern):
# 1. Terraform creates infrastructure (SA, Artifact Registry, metrics)
# 2. gcloud grants IAM roles to service account
# 3. Docker builds and pushes image
# 4. gcloud run deploy creates/updates the Cloud Run service

# =============================================================================
# OBSERVABILITY
# =============================================================================

# Log-based metric for tracking agent invocations
resource "google_logging_metric" "agent_invocations" {
  depends_on = [time_sleep.api_propagation]
  name        = "${local.service_name}-invocations"
  description = "Count of agent invocations for {{ config.name }}"
  project     = var.project_id

  filter = <<-EOT
    resource.type="cloud_run_revision"
    resource.labels.service_name="${local.service_name}"
    jsonPayload.message=~"invoke|Invoke"
  EOT

  metric_descriptor {
    metric_kind = "DELTA"
    value_type  = "INT64"
    unit        = "1"
  }
}

# Log-based metric for tracking errors
resource "google_logging_metric" "agent_errors" {
  depends_on = [time_sleep.api_propagation]
  name        = "${local.service_name}-errors"
  description = "Count of errors for {{ config.name }}"
  project     = var.project_id

  filter = <<-EOT
    resource.type="cloud_run_revision"
    resource.labels.service_name="${local.service_name}"
    severity>=ERROR
  EOT

  metric_descriptor {
    metric_kind = "DELTA"
    value_type  = "INT64"
    unit        = "1"
  }
}
