# Makefile for AgentCore Deployment
# Generated by Bedsheet v0.4.7
# Project: {{ config.name }}

.PHONY: help build push deploy destroy clean test logs

# Configuration
PROJECT_NAME := {{ project_name }}
AWS_REGION := {{ agentcore.region }}
ECR_REPO := $(shell terraform output -raw ecr_repository_url 2>/dev/null || echo "not-deployed")

help:
	@echo "AgentCore Deployment Commands:"
	@echo ""
	@echo "  make build        - Build runtime container and Lambda zip"
	@echo "  make push         - Push container to ECR"
	@echo "  make deploy       - Deploy with Terraform"
	@echo "  make destroy      - Destroy all resources"
	@echo "  make logs         - Tail CloudWatch logs"
	@echo "  make test         - Run local tests"
	@echo "  make clean        - Clean build artifacts"
	@echo ""

# Build runtime container
build: build-runtime build-lambda

build-runtime:
	@echo "Building runtime container..."
	docker build --platform linux/arm64 -t $(PROJECT_NAME)-runtime:latest -f runtime/Dockerfile .

build-lambda:
	@echo "Building Lambda zip..."
	cd lambda && pip install -r requirements.txt -t package/
	cd lambda/package && zip -r ../lambda.zip .
	cd lambda && zip lambda.zip handler.py
	mv lambda/lambda.zip .

# Push to ECR
push: build-runtime
	@echo "Pushing to ECR..."
	aws ecr get-login-password --region $(AWS_REGION) | docker login --username AWS --password-stdin $(ECR_REPO)
	docker tag $(PROJECT_NAME)-runtime:latest $(ECR_REPO):latest
	docker push $(ECR_REPO):latest

# Package runtime for S3 upload
package-runtime:
	@echo "Packaging runtime code..."
	zip -r runtime.zip runtime/ agents/ -x "*.pyc" -x "*__pycache__*"

# Terraform commands
init:
	terraform init

plan:
	terraform plan -var-file=terraform.tfvars

deploy: package-runtime build-lambda
	@echo "Deploying to AgentCore..."
	terraform apply -var-file=terraform.tfvars -auto-approve

destroy:
	@echo "Destroying AgentCore resources..."
	terraform destroy -var-file=terraform.tfvars -auto-approve

# Development
test:
	@echo "Running local tests..."
	cd runtime && python -m pytest ../tests/ -v

dev:
	@echo "Starting local development server..."
	cd runtime && uvicorn app:app --reload --port 8080

# Logs
logs:
	@echo "Tailing CloudWatch logs..."
	aws logs tail /aws/agentcore/$(PROJECT_NAME) --follow --region $(AWS_REGION)

# Clean
clean:
	rm -rf runtime.zip lambda.zip lambda/package
	rm -rf .terraform .terraform.lock.hcl
	rm -f terraform.tfstate terraform.tfstate.backup
	docker rmi $(PROJECT_NAME)-runtime:latest 2>/dev/null || true
