"""Lambda Handler for AgentCore Gateway Tools.

Generated by Bedsheet v0.4.7
Project: {{ config.name }}

This Lambda function handles tool invocations from AgentCore Gateway.
Each @action from the Bedsheet agent is available as a tool.
"""
import json
import logging
import os

logger = logging.getLogger()
logger.setLevel(logging.INFO)

# Environment variables
PROJECT_NAME = os.environ.get("PROJECT_NAME", "{{ project_name }}")
ENVIRONMENT = os.environ.get("ENVIRONMENT", "dev")


def lambda_handler(event: dict, context) -> dict:
    """Main Lambda entry point for AgentCore Gateway tool invocations.

    Args:
        event: Gateway tool invocation event
        context: Lambda context

    Returns:
        Tool execution result
    """
    logger.info(f"Tool invocation: {json.dumps(event)}")

    try:
        # Extract tool name and parameters from Gateway event
        tool_name = event.get("tool_name") or event.get("name")
        parameters = event.get("parameters") or event.get("input", {})

        if not tool_name:
            return _error_response("Missing tool_name in event")

        # Route to appropriate tool handler
        result = _execute_tool(tool_name, parameters)

        return {
            "statusCode": 200,
            "body": json.dumps({
                "result": result,
                "tool_name": tool_name,
            })
        }

    except Exception as e:
        logger.error(f"Tool execution error: {e}", exc_info=True)
        return _error_response(str(e))


def _execute_tool(tool_name: str, parameters: dict):
    """Execute a tool by name with given parameters.

    Args:
        tool_name: Name of the tool to execute
        parameters: Tool input parameters

    Returns:
        Tool execution result
    """
    # Tool implementations
    tools = {
        {% for tool in agent.tools %}
        "{{ tool.name }}": _tool_{{ tool.name | replace('-', '_') }},
        {% endfor %}
    }

    if tool_name not in tools:
        raise ValueError(f"Unknown tool: {tool_name}. Available: {list(tools.keys())}")

    return tools[tool_name](parameters)


def _error_response(message: str) -> dict:
    """Create an error response."""
    return {
        "statusCode": 500,
        "body": json.dumps({
            "error": message,
        })
    }


# -----------------------------------------------------------------------------
# Tool Implementations
# -----------------------------------------------------------------------------
# NOTE: These are placeholder implementations. You should update these
# to match your actual tool logic from the Bedsheet @action decorators.
{% for tool in agent.tools %}

def _tool_{{ tool.name | replace('-', '_') }}(params: dict):
    """{{ tool.description }}

    Parameters:
    {% for param_name, param_schema in tool.parameters_schema.get('properties', {}).items() %}
        {{ param_name }}: {{ param_schema.get('type', 'any') }}{% if param_schema.get('description') %} - {{ param_schema.get('description') }}{% endif %}

    {% endfor %}
    """
    # TODO: Implement actual tool logic
    # This is a placeholder that returns the parameters
    logger.info(f"Executing {{ tool.name }} with params: {params}")

    # Extract parameters
    {% for param_name in tool.parameters_schema.get('properties', {}).keys() %}
    {{ param_name }} = params.get("{{ param_name }}")
    {% endfor %}

    # Placeholder response
    return {
        "tool": "{{ tool.name }}",
        "status": "executed",
        "params": params,
        "message": "Tool executed successfully. Update this implementation."
    }
{% endfor %}
