# Amazon Bedrock AgentCore Deployment
# Generated by Bedsheet v0.4.7
# Project: {{ config.name }}

terraform {
  required_version = ">= 1.0.0"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = ">= 6.17.0"  # AgentCore requires v6.17+
    }
  }
}

provider "aws" {
  region = var.aws_region

  default_tags {
    tags = {
      ManagedBy       = "Bedsheet"
      BedsheetVersion = "0.4.7"
      Project         = var.project_name
      Environment     = local.workspace
    }
  }
}

# -----------------------------------------------------------------------------
# Local Values
# -----------------------------------------------------------------------------

locals {
  workspace   = terraform.workspace
  name_prefix = "${var.project_name}-${local.workspace}"
}

# -----------------------------------------------------------------------------
# ECR Repository for Runtime Container
# -----------------------------------------------------------------------------

resource "aws_ecr_repository" "runtime" {
  name                 = "bedsheet-${local.name_prefix}-runtime"
  image_tag_mutability = "MUTABLE"
  force_delete         = true

  image_scanning_configuration {
    scan_on_push = true
  }

  tags = {
    AgentType = "{{ 'Supervisor' if agent.is_supervisor else 'SingleAgent' }}"
  }
}

resource "aws_ecr_lifecycle_policy" "runtime" {
  repository = aws_ecr_repository.runtime.name

  policy = jsonencode({
    rules = [{
      rulePriority = 1
      description  = "Keep last 5 images"
      selection = {
        tagStatus   = "any"
        countType   = "imageCountMoreThan"
        countNumber = 5
      }
      action = {
        type = "expire"
      }
    }]
  })
}

# -----------------------------------------------------------------------------
# IAM Role for AgentCore Runtime
# -----------------------------------------------------------------------------

data "aws_caller_identity" "current" {}
data "aws_region" "current" {}

resource "aws_iam_role" "runtime_role" {
  name = "bedsheet-${local.name_prefix}-runtime-role"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Action = "sts:AssumeRole"
      Effect = "Allow"
      Principal = {
        Service = "bedrock-agentcore.amazonaws.com"
      }
    }]
  })

  tags = {
    AgentType = "{{ 'Supervisor' if agent.is_supervisor else 'SingleAgent' }}"
  }
}

resource "aws_iam_role_policy" "runtime_permissions" {
  name = "bedsheet-${local.name_prefix}-runtime-permissions"
  role = aws_iam_role.runtime_role.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = [
          "bedrock:InvokeModel",
          "bedrock:InvokeModelWithResponseStream"
        ]
        Resource = "arn:aws:bedrock:${data.aws_region.current.name}::foundation-model/{{ agentcore.bedrock_model }}"
      },
      {
        Effect = "Allow"
        Action = [
          "logs:CreateLogGroup",
          "logs:CreateLogStream",
          "logs:PutLogEvents"
        ]
        Resource = "arn:aws:logs:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:*"
      },
      {
        Effect = "Allow"
        Action = [
          "ecr:GetAuthorizationToken",
          "ecr:BatchCheckLayerAvailability",
          "ecr:GetDownloadUrlForLayer",
          "ecr:BatchGetImage"
        ]
        Resource = "*"
      }
    ]
  })
}

# -----------------------------------------------------------------------------
# AgentCore Runtime
# -----------------------------------------------------------------------------

resource "aws_bedrockagentcore_runtime" "main" {
  runtime_name = "${local.name_prefix}"

  network_configuration {
    network_mode = "PUBLIC"
  }

  runtime_artifacts {
    s3 {
      s3_uri = "s3://${aws_s3_bucket.artifacts.bucket}/${aws_s3_object.runtime_code.key}"
    }
  }

  role_arn = aws_iam_role.runtime_role.arn

  tags = {
    AgentType   = "{{ 'Supervisor' if agent.is_supervisor else 'SingleAgent' }}"
    AgentName   = "{{ agent.name }}"
  }
}

# S3 bucket for runtime artifacts
resource "aws_s3_bucket" "artifacts" {
  bucket        = "bedsheet-${local.name_prefix}-artifacts-${data.aws_caller_identity.current.account_id}"
  force_destroy = true

  tags = {
    Purpose = "AgentCore Runtime Artifacts"
  }
}

resource "aws_s3_bucket_versioning" "artifacts" {
  bucket = aws_s3_bucket.artifacts.id
  versioning_configuration {
    status = "Enabled"
  }
}

# Upload runtime code as zip
resource "aws_s3_object" "runtime_code" {
  bucket = aws_s3_bucket.artifacts.id
  key    = "runtime/code.zip"
  source = "${path.module}/runtime.zip"
  etag   = filemd5("${path.module}/runtime.zip")
}

{% if agent.tools %}
# -----------------------------------------------------------------------------
# AgentCore Gateway for Tool Integration
# -----------------------------------------------------------------------------

resource "aws_bedrockagentcore_gateway" "main" {
  gateway_name = "${local.name_prefix}-gateway"

  protocol_type = "MCP"

  authorizer_configuration {
    authorizer_type = "IAM"
  }

  tags = {
    Purpose = "Tool Gateway for {{ agent.name }}"
  }
}

# -----------------------------------------------------------------------------
# Lambda Functions for Tools
# -----------------------------------------------------------------------------

resource "aws_iam_role" "lambda_role" {
  name = "bedsheet-${local.name_prefix}-lambda-role"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Action = "sts:AssumeRole"
      Effect = "Allow"
      Principal = {
        Service = "lambda.amazonaws.com"
      }
    }]
  })
}

resource "aws_iam_role_policy_attachment" "lambda_basic" {
  role       = aws_iam_role.lambda_role.name
  policy_arn = "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
}

# Lambda function for all tools
resource "aws_lambda_function" "tools" {
  function_name = "bedsheet-${local.name_prefix}-tools"
  role          = aws_iam_role.lambda_role.arn
  handler       = "handler.lambda_handler"
  runtime       = "python3.11"
  architectures = ["arm64"]
  memory_size   = {{ agentcore.lambda_memory }}
  timeout       = 30

  filename         = "${path.module}/lambda.zip"
  source_code_hash = filebase64sha256("${path.module}/lambda.zip")

  environment {
    variables = {
      PROJECT_NAME = var.project_name
      ENVIRONMENT  = local.workspace
    }
  }

  tags = {
    Purpose = "Tool handlers for {{ agent.name }}"
  }
}

# Gateway tool registrations
{% for tool in agent.tools %}
resource "aws_bedrockagentcore_gateway_target" "{{ tool.name }}" {
  gateway_identifier = aws_bedrockagentcore_gateway.main.gateway_identifier

  name        = "{{ tool.name }}"
  description = "{{ tool.description }}"

  lambda_target_configuration {
    lambda_arn = aws_lambda_function.tools.arn
  }

  tags = {
    ToolName = "{{ tool.name }}"
  }
}
{% endfor %}

# Allow Gateway to invoke Lambda
resource "aws_lambda_permission" "gateway_invoke" {
  statement_id  = "AllowAgentCoreGatewayInvoke"
  action        = "lambda:InvokeFunction"
  function_name = aws_lambda_function.tools.function_name
  principal     = "bedrock-agentcore.amazonaws.com"
  source_arn    = aws_bedrockagentcore_gateway.main.arn
}
{% endif %}

{% if agent.collaborators %}
# -----------------------------------------------------------------------------
# Collaborator Agents (Multi-Agent)
# -----------------------------------------------------------------------------

{% for collaborator in agent.collaborators %}
# Collaborator: {{ collaborator.name }}
resource "aws_bedrockagentcore_runtime" "collaborator_{{ collaborator.name | lower | replace(' ', '_') }}" {
  runtime_name = "${local.name_prefix}-{{ collaborator.name | lower | replace(' ', '_') }}"

  network_configuration {
    network_mode = "PUBLIC"
  }

  runtime_artifacts {
    s3 {
      s3_uri = "s3://${aws_s3_bucket.artifacts.bucket}/collaborators/{{ collaborator.name | lower }}/code.zip"
    }
  }

  role_arn = aws_iam_role.runtime_role.arn

  tags = {
    AgentType  = "Collaborator"
    AgentName  = "{{ collaborator.name }}"
    Supervisor = "{{ agent.name }}"
  }
}
{% endfor %}
{% endif %}
