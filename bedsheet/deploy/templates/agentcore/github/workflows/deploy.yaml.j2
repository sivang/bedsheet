# Deploy Workflow for AgentCore
# Generated by Bedsheet v0.4.7

name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  PROJECT_NAME: {{ project_name }}
  AWS_REGION: {{ agentcore.region }}
  TF_VAR_project_name: {{ project_name }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ "{{ github.event.inputs.environment || 'dev' }}" }}

    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ "{{ secrets.AWS_ROLE_ARN }}" }}
          aws-region: ${{ "{{ env.AWS_REGION }}" }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push runtime container
        env:
          ECR_REGISTRY: ${{ "{{ steps.login-ecr.outputs.registry }}" }}
          IMAGE_TAG: ${{ "{{ github.sha }}" }}
        run: |
          docker build --platform linux/arm64 \
            -t $ECR_REGISTRY/bedsheet-${{ "{{ env.PROJECT_NAME }}" }}-runtime:$IMAGE_TAG \
            -t $ECR_REGISTRY/bedsheet-${{ "{{ env.PROJECT_NAME }}" }}-runtime:latest \
            -f runtime/Dockerfile .
          docker push $ECR_REGISTRY/bedsheet-${{ "{{ env.PROJECT_NAME }}" }}-runtime --all-tags

      - name: Package runtime for S3
        run: |
          zip -r runtime.zip runtime/ agents/ -x "*.pyc" -x "*__pycache__*"

      - name: Build Lambda package
        run: |
          cd lambda
          pip install -r requirements.txt -t package/
          cd package && zip -r ../lambda.zip .
          cd .. && zip lambda.zip handler.py
          mv lambda.zip ../

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: terraform init

      - name: Select Terraform Workspace
        run: |
          terraform workspace select ${{ "{{ github.event.inputs.environment || 'dev' }}" }} || \
          terraform workspace new ${{ "{{ github.event.inputs.environment || 'dev' }}" }}

      - name: Terraform Plan
        run: terraform plan -var-file=terraform.tfvars -out=tfplan

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan

      - name: Output Deployment Info
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Runtime ARN:** $(terraform output -raw runtime_arn)" >> $GITHUB_STEP_SUMMARY
          echo "**Runtime Endpoint:** $(terraform output -raw runtime_endpoint)" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ "{{ github.event.inputs.environment || 'dev' }}" }}" >> $GITHUB_STEP_SUMMARY
